{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>üßæ Sales Records</h2>
  <div>
    <a href="{{ url_for('ar_ap.billing_invoices') }}" class="btn btn-info me-2">üìã Billing Invoices</a>
    <a href="{{ url_for('core.pos') }}" class="btn btn-primary">‚ûï New Sale (POS)</a>
  </div>
</div>

<!-- üîé Filters -->
<form method="get" class="row g-2 mb-3">
  <div class="col-md-3">
    <input type="text" name="search" class="form-control" placeholder="Search by ID, Doc #, or Customer" value="{{ request.args.get('search', '') }}">
  </div>
  <div class="col-md-3">
    <input type="date" name="start_date" class="form-control" placeholder="Start Date" value="{{ request.args.get('start_date', '') }}">
  </div>
  <div class="col-md-3">
    <input type="date" name="end_date" class="form-control" placeholder="End Date" value="{{ request.args.get('end_date', '') }}">
  </div>
  <div class="col-md-3">
    <button class="btn btn-secondary w-100" type="submit">üîç Filter</button>
  </div>
</form>

<!-- üí∞ Enhanced Summary -->
{% if summary %}
<div class="row mb-3">
  <div class="col-md-3">
    <div class="card text-white bg-primary">
      <div class="card-body">
        <h6 class="card-title">Total Sales</h6>
        <h4>‚Ç±{{ summary.total_sales | money }}</h4>
        <small>{{ summary.count }} transactions</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-success">
      <div class="card-body">
        <h6 class="card-title">Cash Sales (POS)</h6>
        <h4>{{ summary.cash_sales_count }}</h4>
        <small>Paid immediately</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-info">
      <div class="card-body">
        <h6 class="card-title">Billing Invoices (AR)</h6>
        <h4>{{ summary.billing_invoices_count }}</h4>
        <small>Credit sales</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-white bg-warning">
      <div class="card-body">
        <h6 class="card-title">Total VAT</h6>
        <h4>‚Ç±{{ summary.total_vat | money }}</h4>
        <small>Discounts: ‚Ç±{{ summary.total_discount | money }}</small>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- üìä Enhanced Table -->
<div class="card shadow-sm">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Type</th>
            <th>Doc #</th>
            <th>Date</th>
            <th>Customer</th>
            <th>Total</th>
            <th>Paid</th>
            <th>Balance</th>
            <th>VAT</th>
            <th>Discount</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in sales %}
          <tr class="{{ 'table-secondary text-decoration-line-through' if s.status == 'voided' else '' }}">
            <!-- Type Badge -->
            <td>
              {% if s.type == 'Cash Sale' %}
              <span class="badge bg-success">üíµ Cash</span>
              {% else %}
              <span class="badge bg-info">üìã Billing</span>
              {% endif %}
            </td>
            
            <!-- Document Number -->
            <td><strong>{{ s.document_number }}</strong></td>
            
            <!-- Date -->
            <td>{{ s.date.strftime('%Y-%m-%d %H:%M') if s.date else '‚Äî' }}</td>
            
            <!-- Customer -->
            <td>{{ s.customer_name or '‚Äî' }}</td>
            
            <!-- Total -->
            <td><strong>‚Ç±{{ s.total | money }}</strong></td>
            
            <!-- Paid Amount -->
            <td class="text-success">‚Ç±{{ s.paid | money }}</td>
            
            <!-- Balance -->
            <td>
              {% if s.balance > 0 %}
              <span class="text-danger fw-bold">‚Ç±{{ s.balance | money }}</span>
              {% else %}
              <span class="text-muted">‚Äî</span>
              {% endif %}
            </td>
            
            <!-- VAT -->
            <td>‚Ç±{{ s.vat | money }}</td>
            
            <!-- Discount -->
            <td>
              {% if s.discount_value > 0 %}
              <span class="text-warning">‚Ç±{{ s.discount_value | money }}</span>
              {% else %}
              ‚Äî
              {% endif %}
            </td>
            
            <!-- Status -->
            <td>
              {% if s.status == 'voided' %}
                <span class="badge bg-dark">VOIDED</span>
              {% elif s.status == 'Paid' or s.status == 'paid' %}
                <span class="badge bg-success">Paid</span>
              {% elif s.status == 'Partially Paid' %}
                <span class="badge bg-warning text-dark">Partial</span>
              {% elif s.status == 'Open' %}
                <span class="badge bg-danger">Unpaid</span>
              {% elif s.status == 'refunded' %}
                <span class="badge bg-secondary">Refunded</span>
              {% else %}
                <span class="badge bg-secondary">{{ s.status }}</span>
              {% endif %}
            </td>
            
            <!-- Actions -->
            <td>
              {% if s.type == 'Cash Sale' %}
                <a href="{{ url_for('core.view_sale', sale_id=s.id) }}" class="btn btn-sm btn-outline-info" title="View Details">
                  <i class="bi bi-eye"></i>
                </a>
                {% if s.status != 'voided' %}
                <a href="{{ url_for('core.print_receipt', sale_id=s.id) }}" class="btn btn-sm btn-outline-primary" target="_blank" title="Print Receipt">
                  <i class="bi bi-printer"></i>
                </a>
                <button class="btn btn-sm btn-outline-danger" 
                        data-bs-toggle="modal" 
                        data-bs-target="#voidModal"
                        onclick="setVoidTarget('{{ url_for('void.void_sale', sale_id=s.id) }}', 'Sale #{{ s.id }} ({{ s.document_number }})')"
                        title="Void Sale">
                  <i class="bi bi-x-circle"></i>
                </button>
                {% endif %}
              {% else %}
                <a href="{{ url_for('ar_ap.billing_invoices') }}" class="btn btn-sm btn-outline-info" title="View Invoice">
                  <i class="bi bi-file-earmark-text"></i>
                </a>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="11" class="text-center text-muted py-4">
              <i class="bi bi-inbox" style="font-size: 2rem;"></i>
              <p class="mb-0 mt-2">No sales recorded yet.</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚¨áÔ∏è Export Buttons -->
<div class="mt-3 mb-4">
  <a href="{{ url_for('core.export_sales', format='csv', search=search, start_date=start_date, end_date=end_date) }}" class="btn btn-outline-success">
    <i class="bi bi-download"></i> Export CSV
  </a>
</div>

<!-- üìÑ Pagination -->
{% if pagination.pages > 1 %}
<nav aria-label="Sales pagination">
  <ul class="pagination justify-content-center">
    {% if pagination.has_prev %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('core.sales', page=pagination.prev_num, search=search, start_date=start_date, end_date=end_date) }}">Previous</a>
    </li>
    {% endif %}

    <li class="page-item disabled">
      <a class="page-link">Page {{ pagination.page }} of {{ pagination.pages }}</a>
    </li>

    {% if pagination.has_next %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('core.sales', page=pagination.next_num, search=search, start_date=start_date, end_date=end_date) }}">Next</a>
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<!-- Void Confirmation Modal -->
<div class="modal fade" id="voidModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="voidForm" method="POST">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>Void Transaction
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <strong>Warning:</strong> This action cannot be undone. All related journal entries will be reversed.
          </div>
          <p>You are about to void: <strong id="voidTargetName"></strong></p>
          <div class="mb-3">
            <label class="form-label"><strong>Void Reason *</strong></label>
            <textarea name="void_reason" class="form-control" rows="3" placeholder="Enter the reason for voiding this transaction..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-x-circle me-1"></i> Void Transaction
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function setVoidTarget(actionUrl, targetName) {
  document.getElementById('voidForm').action = actionUrl;
  document.getElementById('voidTargetName').textContent = targetName;
}

// Bootstrap Tooltip Initialization
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>
{% endblock %}